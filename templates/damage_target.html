{% extends "layout_report.html" %}

{% block the_main %}
<main id="report-damage">
  <div>
    <table>
      <caption>damage to target</caption>

      <tr>
      {% for _th in HEADS %}
        <th>{{ _th }}</th>
      {% endfor %}
      </tr>
      {% for player_name, player_total in TOTAL.items() %}
      <tr>
        <td class="player-cell">
          <a class="{{ CLASS_DATA[player_name] }}" href="/reports/{{ REPORT_ID }}/player/{{ player_name }}/{{ QUERY }}">{{ player_name }}</a>
        </td>
        <td class="total-cell">{{ player_total }}</td>
        {% for tguid, _t in FORMATTED.items() %}
        <td class="total-cell">{{ _t.get(player_name, 0) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </table>
  </div>
  <section id="class-filter">
    <h2>CLASS FILTER â–²</h2>
    <div id="class-filter-wrap"></div>
  </section>
</main>
{% endblock the_main %}
{% block the_scripts %}
<script>
  const getCellValue = (tr, idx) => tr.children[idx].innerText.replace(/ /g, '');
  const comparer = idx => (a, b) => getCellValue(b, idx) - getCellValue(a, idx);

  document.querySelectorAll('th').forEach(th => th.addEventListener('click', () => {
    const tbody = th.closest('tbody');
    Array.from(tbody.querySelectorAll('tr:nth-child(n+2)'))
         .sort(comparer(th.cellIndex))
         .forEach(tr => tbody.appendChild(tr));
  }));

  const _storage = window.localStorage;
  const classFilter = document.getElementById('class-filter-wrap')
  const CLASSES_TO_LOW = {
    "Death Knight": "death-knight",
    "Druid": "druid",
    "Hunter": "hunter",
    "Mage": "mage",
    "Paladin": "paladin",
    "Priest": "priest",
    "Rogue": "rogue",
    "Shaman": "shaman",
    "Warlock": "warlock",
    "Warrior": "warrior"
  }

  function addInput(class_name) {
    const class_name_low = CLASSES_TO_LOW[class_name];
    const cb_id = `${class_name_low}-cb`;

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = cb_id;
    input.checked = _storage.getItem(cb_id) == "true" ? true : false;
    classFilter.appendChild(input);

    const label = document.createElement('label');
    label.innerText = class_name;
    label.setAttribute('for', cb_id);
    classFilter.appendChild(label);
    return input
  }
  function cb_checked(cb) {
    const checked = cb.checked;
    _storage.setItem(cb.id, checked);
    const class_low = cb.id.replace("-cb", "");
    const display = checked ? 'table-row' : 'none';
    document.querySelectorAll(`.${class_low}`).forEach(a => a.parentNode.parentNode.style.display = display);
  }

  for (let class_name in CLASSES_TO_LOW) {
    const cb = addInput(class_name);
    cb.checked = _storage.getItem(cb.id) != "false" ? true : false;
    cb_checked(cb);
    cb.addEventListener('change', () => cb_checked(cb));
  }
</script>
{% endblock the_scripts %}
