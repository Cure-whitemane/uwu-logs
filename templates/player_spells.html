{% extends "layout_report.html" %}

{% block add_style %}
<style>
 .tooltip {
  position: absolute;
  top: 0;
  height: 100%;
  left: var(--margin);
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: fit-content;
  background-color: #555;
  color: #fff;
  text-align: center;
  padding: 5px 0;
  border-radius: 6px;

  position: absolute;
  z-index: 1;
  top: 100%;
  left: 100%;

  opacity: 0;
  transition: opacity 0.1s;
}
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}
.spell-name {
  min-width: 30ch;
  text-align: center;
  display: table-cell;
}
.spell-history-wrap {
  width: 80%;
  overflow-x: auto;
}
.spell-history {
  display: table-cell;
  position: relative;
  width: 200vw;
}
.tooltip {
  width: .2rem;
  height: 100%;
  background-color: currentColor;
}

#flag-filter-wrap {
  position: fixed;
  bottom: var(--bottom-row-two);
  margin: 1rem;
}
#flag-filter-wrap > span {
  font-size: 150%;
  padding: .1em;
  padding-left: 1ch;
  border: .1em solid var(--primary-color);
  border-radius: .3em;
  background-color: var(--background)
}
#flag-filter-wrap > #flag-filter {
  padding: .1rem;
  display: none;
  width: max-content;
  position: absolute;
  bottom: 100%;
  left: 0;
  z-index: 1;
  background-color: var(--background);
  box-shadow: inset 0 0 .5em var(--primary-color);
  border-radius: .5em;
}
#flag-filter-wrap:hover > #flag-filter {
  display: block;
}
.flag-color-picker {
  width: 2em;
  border: none;
}
.flag-checkbox:checked + label {
  color: var(--secondary-color);
}
</style>
{% endblock add_style %}

{% block the_main %}
<main id="dmg-done">
<section>
  <ul id="player-nav">
    <li><a href="/reports/{{ REPORT_ID }}/player/{{ SOURCE_NAME }}/{{ QUERY }}">DAMAGE</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/heal/{{ SOURCE_NAME }}/{{ QUERY }}">HEAL</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/taken/{{ SOURCE_NAME }}/{{ QUERY }}">TAKEN</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/player_auras/{{ SOURCE_NAME }}/{{ QUERY }}">AURAS</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/casts/{{ SOURCE_NAME }}/{{ QUERY }}">CASTS</a></li>
  </ul>
</section>
<section id="casts-section" style="display: none">
  <section id="flag-filter-wrap">
    <span>FLAG FILTER â‰¡</span>
    <ul id="flag-filter">
      {% for flag in FLAGS %}
      <li>
        <input type="color" class="flag-color-picker">
        <input id="{{ flag }}" type="checkbox" class="flag-checkbox" checked>
        <label class="tab" for="{{ flag }}">{{ flag }}</label>
      </li>
      {% endfor %}
    </ul>
  </section>
  <table>
    <tbody>
      {% for spell_id, _asdasd in DATA.items() %}
      <tr class="spell-row">
        <td class="spell-name">
          <a class="{{ SPELLS[spell_id]['color'] }}" href="/reports/{{ REPORT_ID }}/spell/{{ spell_id }}/{{ QUERY }}">{{ SPELLS[spell_id]['name'] }}</a>
        </td>
        <td class="spell-count"></td>
        <td class="spell-history">
          {% for ts, from_start, flag, target, etc in _asdasd %}
          <div class="tooltip {{ flag }}" style="--margin: {{ ts }}">
            <div class="tooltiptext">
              <p>{{ from_start }}</p>
              <p>{{ flag }}</p>
              <p>{{ target }}</p>
              <p>{{ etc }}</p>
            </div>
          </div>
          {% endfor %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  
</section>
</main>
{% endblock the_main %}

{% block the_scripts %}
<script>
  function has_visible(row) {
    for (let tooltip of row.getElementsByClassName("tooltip")) {
      if (tooltip.style.display != "none") return true;
    }
  }
  
  function spell_count(row) {
    let c = 0;
    for (let tooltip of row.getElementsByClassName("tooltip")) {
      if (tooltip.style.display != "none") c = c + 1;
    }
    return c
  }

  function toggle_rows() {
    for (let row of document.getElementsByClassName("spell-row")) {
      row.style.display = has_visible(row) ? "" : "none";
      row.querySelector(".spell-count").innerText = spell_count(row);
    }
  }
  
  function toggle_nodes(input) {
    for (let div of document.getElementsByClassName(input.id)) {
      div.style.display = input.checked ? "" : "none";
    }
  }

  function change_color(flag, color) {
    for (let tooltip of document.getElementsByClassName(flag)) {
      tooltip.style.color = color;
    }
  }

  const DEFAULT_COLORS = {
    "SWING_DAMAGE": "#dcdcdc",
    "SPELL_DAMAGE": "#3f3fcf",
    "SPELL_MISSED": "#5b5a99",
    "SPELL_PERIODIC_DAMAGE": "#783c9f",
    "SPELL_AURA_APPLIED": "#41cc00",
    "SPELL_AURA_APPLIED_DOSE": "#41cc00",
    "SPELL_AURA_REFRESH": "#ccad00",
    "SPELL_AURA_REMOVED": "#cc7a00",
    "SPELL_CAST_SUCCESS": "#9200cc",
  }

  function init() {
    document.querySelectorAll("#flag-filter li").forEach(li => {
      const checkbox = li.querySelector(".flag-checkbox");
      const color_ID = `${checkbox.id}_COLOR`
      const colorPicker = li.querySelector(".flag-color-picker");
      const label = li.querySelector("label");

      checkbox.checked = localStorage.getItem(checkbox.id) !== "false";
      toggle_nodes(checkbox);
      checkbox.addEventListener("change", () => {
        toggle_nodes(checkbox);
        toggle_rows();
        localStorage.setItem(checkbox.id, checkbox.checked);
      })

      colorPicker.value = localStorage.getItem(color_ID) ?? DEFAULT_COLORS[checkbox.id] ?? "#dcdcdc";
      label.style.setProperty('--secondary-color', colorPicker.value);
      change_color(checkbox.id, colorPicker.value);
      
      colorPicker.addEventListener("change", () => {
        localStorage.setItem(color_ID, colorPicker.value);
        label.style.setProperty('--secondary-color', colorPicker.value);
        change_color(checkbox.id, colorPicker.value);
      })
    })
    toggle_rows();
    document.getElementById("casts-section").style.display = "";
  }

  window.addEventListener('DOMContentLoaded', init)
</script>
{% endblock the_scripts %}