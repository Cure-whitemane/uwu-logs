{% extends "layout.html" %}

{% block the_main %}
<main>
<section class="upload">
  <h2>Upload progress:</h2>
  <div id="upload-status">Preparing...</div>
  <section>
    <table id="upload-table" style="display: none;">
      <thead>
        <tr>
          <th style="min-width: 40ch;">Slice ID</th>
          <th style="min-width: 20ch;">Status</th>
        </tr>
      </thead>
      <tbody id="upload-table-tbody"></tbody>
    </table>
  </section>
</section>
</main>
{% endblock the_main %}
{% block the_scripts %}
<script>
  const uploadStatus = document.getElementById("upload-status");
  const table = document.getElementById("upload-table");
  const tbody = document.getElementById("upload-table-tbody");
  const request = new XMLHttpRequest();
  
  function newRow(report_name, report_data, done) {
    const tr = document.createElement("tr");
    const report_link_cell = document.createElement("td");
    if (done) {
      const report_link = document.createElement("a");
      report_link.href = `/reports/${report_name}`;
      report_link.target = "_blank";
      report_link.innerText = report_name;
      report_link_cell.appendChild(report_link);
    } else {
      report_link_cell.innerText = report_name;
    }
    tr.appendChild(report_link_cell);
    
    const status_cell = document.createElement("td");
    status_cell.innerText = report_data.status;
    tr.appendChild(status_cell);
    return tr
  }

  let gotResponse = true;
  const t = setInterval(() => {
    if (gotResponse === true) {
      gotResponse = false;
      request.open("GET", "/upload/check_progress", true);
      request.send();
    }
  }, 250)

  request.onreadystatechange = () => {
    if (request.readyState != 4 || request.status != 200) return;
    const res = JSON.parse(request.response);

    const done = res.done == 1
    if (done) clearInterval(t);
    gotResponse = true;

    uploadStatus.innerText = res.status || "Preparing...";
    if (res.slices) {
      table.style.display = "table";
      tbody.innerHTML = "";
      for (let slice_name in res.slices) {
        const slice = res.slices[slice_name]
        tbody.appendChild(newRow(slice_name, slice, done))
      }
    }
  }
</script>
{% endblock the_scripts %}
