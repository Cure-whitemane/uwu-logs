{% extends "layout_report.html" %}

{% block add_style %}
<style>
.rectangle-cell,
th {
  border-left: 10px solid var(--table-border);
}

tr:is(:last-child, :first-child) td {
  border-bottom: 1px solid var(--table-border);
}
.rectangle-cell > div {
  width: var(--width);
  height: 1em;
  border-radius: 0.1em;
}
.damage-bar, .taken-bar {
  box-shadow: .1em .1em 1em darkred;
  animation: 3s linear infinite;
  animation-name: dmgbar;
}
@keyframes dmgbar {
  0%,
  100% {background-color: hsl(0, 85%, 30%);}
  50%  {background-color: hsl(0, 100%, 25%);}
}

.heal-bar {
  box-shadow: .1em .1em 1em forestgreen;
  animation: 3s linear infinite;
  animation-name: healbar;
}
@keyframes healbar {
  0%,
  100% {background-color: hsl(120, 75%, 25%);}
  50%  {background-color: hsl(120, 100%, 25%);}
}

.player-cell div {
  display: inline-block;
  vertical-align: text-bottom;
  max-height: 1.1em;
  max-width: 1.1em;
  min-height: 1.1em;
  min-width: 1.1em;
}
tr:nth-child(n+2) .player-cell div {
  background-image: url('/class_icons.jpg?v=2');
  background-repeat: no-repeat;
  background-size: 400% 1100%;
  height: 56px;
  width: 56px;
  background-position-x: calc(var(--spec-i)  * 33.33333%);
  background-position-y: calc(var(--class-i) * 10%);
}
#chart {
  max-height: 20vh;
  width: 100%;
}
.rectangle-cell {
  width: 12rem;
}
</style>
{% endblock add_style %}

{% block scripts_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.1.2/chart.umd.min.js"></script>
{% endblock scripts_head %}

{% block the_main %}
<main id="report-main">
  <section class="table-wrap wrap-player">
    <div>
      <table class="add-player-rank">
        <thead>
          <tr>
            <th class="player-cell">Name</th>
            <th class="col-damage" colspan="3">Damage</th>
            <th class="col-heal" colspan="3">Heal</th>
            <th class="col-taken" colspan="3">Damage Taken</th>
          </tr> 
        </thead>
        <tbody class="table-has-total">
          {% for player_name, data in TABLE.items() %}
          <tr>
            <td class="player-cell" title="{{ data['spec_name'] }}">
              {% if data['spec_icon'] in SPEC_ICON_TO_POSITION %}
              <div style="--class-i: {{ SPEC_ICON_TO_POSITION[data['spec_icon']][0] }}; --spec-i: {{ SPEC_ICON_TO_POSITION[data['spec_icon']][1] }}"></div>
              {% else %}
              <div></div>
              {% endif %}
              <a class="{{ PLAYER_CLASSES[player_name] }}" href="/reports/{{ REPORT_ID }}/player/{{ player_name }}/{{ QUERY }}">{{ player_name }}</a>
            </td>
            <td class="rectangle-cell">
              <!-- {{ data['damage'] }} -->
              {% if 'd_p' in data %}
              <div class="damage-bar" style="--width: {{ data['d_p'] }}%"></div>
              {% endif %}
            </td>
            <td class="total-cell col-damage">{{ data['damage'] }}</td>
            <td class="per-sec-cell">{{ data['dps'] }}</td>
  
            <td class="rectangle-cell">
              <!-- {{ data['heal'] }} -->
              {% if 'h_p' in data %}
              <div class="heal-bar" style="--width: {{ data['h_p'] }}%"></div>
              {% endif %}
            </td>
            <td class="total-cell col-heal">{{ data['heal'] }}</td>
            <td class="per-sec-cell">{{ data['hps'] }}</td>
            
            <td class="rectangle-cell">
              <!-- {{ data['taken'] }} -->
              {% if 't_p' in data %}
              <div class="taken-bar" style="--width: {{ data['t_p'] }}%"></div>
              {% endif %}
            </td>
            <td class="total-cell col-taken">{{ data['taken'] }}</td>
            <td class="per-sec-cell">{{ data['tps'] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  <section id="chart-wrap" style="display: none;">
    <canvas id="chart"></canvas>
  </section>
  <div class="min-max-slider" data-legendnum="2">
    <div class="min-max-slider-inputs">
      <input class="min min-max-slider-half" name="min" type="range" step="1"/>
      <input class="max min-max-slider-half" name="max" type="range" step="1"/>
    </div>
    <div class="min-max-slider-values">
      <span class="min-value"></span>
      <span> - </span>
      <span class="max-value"></span>
      <span class="total-value"></span>
    </div>
    <button class="min-max-slider-submit" type="submit">Slice</button>
  </div>
  <section style="display: none;">
    <p>First Hit: {{ FIRST_HIT }}</p>
    <p>Last Hit: {{ LAST_HIT }}</p>
  </section>
  <script defer src="/static/range.js"></script>
</main>

{% endblock the_main %}

{% block the_scripts %}
<script>
const tbody = document.querySelector("tbody");
const getCellValue = (tr, className) => tr.querySelector(className).textContent.replace(/ /g, "");
const comparer = className => (a, b) => getCellValue(b, className) - getCellValue(a, className);
document.querySelectorAll("th.sortable").forEach(th => th.addEventListener("click", () => {
  Array.from(tbody.querySelectorAll("tr"))
        .sort(comparer(`.total-cell.${th.classList[0]}`))
        .forEach(tr => tbody.appendChild(tr));
}));

const GET_DPS_REQUEST = new XMLHttpRequest();

const CHART_OPTIONS = {
  maintainAspectRatio: false,
  responsive: true,
  animation: false,
  scales: {
    x: {
      grid: {
        color: '#141414',
        tickLength: 1,
      },
    },
    y: {
      grid: {
        color: '#141414',
        tickLength: 1,
      },
      title: {
        display: true,
        text: 'DPS',
      },
      ticks: {
        padding: 0,
      },
    },
  },
  plugins: {
    tooltip: {
      intersect: false,
    },
    legend: {
      display: false,
    },
  },
  interaction: {
    mode: 'index',
  }
};
const CHART = new Chart(document.getElementById('chart'), {
  type: 'line',
  options: CHART_OPTIONS,
});

function make_new_dataset(datapoints) {
  return {
    data: datapoints,
    cubicInterpolationMode: 'monotone',
    borderColor: '#6900cc',
    pointBorderWidth: 0,
  }
}

function chartSetData(datapoints) {
  if (Object.keys(datapoints).length === 0 && CHART.data.datasets.length === 0) {
    return
  }
  const datapoints_values = Object.values(datapoints);
  const datapoints_min = Math.min(...datapoints_values);
  const datapoints_max = Math.max(...datapoints_values);
  CHART.options.scales.y.min = Math.floor(datapoints_min);
  CHART.options.scales.y.max = Math.ceil(datapoints_max);
  CHART.data.datasets[0] = make_new_dataset(datapoints);
  CHART.update();
  document.getElementById('chart-wrap').style.removeProperty("display");
}

GET_DPS_REQUEST.onreadystatechange = () => {
  if (GET_DPS_REQUEST.readyState != 4 || GET_DPS_REQUEST.status != 200) return;
  
  const datapoints = JSON.parse(GET_DPS_REQUEST.response);
  chartSetData(datapoints);
}

(() => {
  const reportID = window.location.pathname.split('/')[2];
  const END_POINT = `/reports/${reportID}/get_dps`;
  const params = new URLSearchParams(window.location.search);
  const params_obj = Object.fromEntries(params);
  GET_DPS_REQUEST.open("POST", END_POINT);
  GET_DPS_REQUEST.send(JSON.stringify(params_obj));
})();
</script>
{% endblock the_scripts %}