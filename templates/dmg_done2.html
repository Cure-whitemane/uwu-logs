{% extends "layout_report.html" %}

{% block scripts_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.1.2/chart.umd.min.js"></script>
{% endblock scripts_head %}

{% block add_style %}
<style>
img {
  min-width: 1em;
  max-width: 1em;
  min-height: 1em;
  max-height: 1em;
}
button {
  /* margin: 0; */
  padding: 0 2ch;
  background: var(--background);
  border: .2rem solid var(--primary-color);
  border-radius: .2rem;
  box-shadow: inset 0 0 .4rem var(--primary-color), 0 .1rem 1rem var(--primary-color);
}
button:hover {
  cursor: pointer;
  box-shadow: inset 0 0 1rem var(--secondary-color), 0 0 1rem var(--secondary-color);
}

#target-select-wrap {
  position: fixed;
  bottom: var(--bottom-row-two);
  background-color: var(--background);
  width: 100%;
  z-index: 10;
  padding-bottom: 1rem;
}
#target-select-wrap select {
  margin-left: 1rem;
  min-width: 22ch;
}
#target-select-wrap button,
#target-select-wrap select {
	font-size: clamp(1vw, 3rem, 5.5vw);
}

.sliced-control {
  min-width: 10ch;
}
#player-info {
	display: flex;
	align-items: end;
  flex-direction: column;
  font-size: 125%;
}
#player-info .player-name-big {
  font-size: 300%;
}
@media (orientation: landscape) {
  #player-info {
    align-items: first baseline;
    justify-content: space-evenly;
    flex-direction: row;
  }
}

#chart-wrap {
  height: 20vh;
  width: 100%;
}
#chart {
  height: 100;
  width: 100%;
}

.table-wrap {
  padding-bottom: 7rem;
}

#dmg-done-main > table > tbody > tr > td:hover {
  background-color: hsl(285, 100%, 15%);
}
/* #dmg-done th:nth-child(n+2),
#dmg-done td:nth-child(2),
#dmg-done td:nth-child(4),
#dmg-done td:nth-child(6),
#dmg-done td:nth-child(8),
#dmg-done td:nth-child(11),
#dmg-done td:nth-child(13) {
  border-left: 3px solid dimgray;
} */
#dmg-done-main > table > tfoot > tr > td {
  border-top: 3px solid dimgray;
}
#dmg-done td:nth-child(n+2) {
  text-align: right;
}

.count,
.total-cell {
  position: relative;
}
td:hover > table {
  display: table;
}
.tooltip {
  display: none;
  position: absolute;
  top: 100%;
  left: 95%;
  z-index: 2;
  box-shadow: 0 0 .2rem .2rem hsl(285, 100%, 20%);
}
.tooltip td {
  min-width: 7ch;
}
.avgs tr:nth-child(1) > td {
  background-color: hsl(140, 100%, 10%);
}
.avgs tr:nth-child(2) > td {
  background-color: hsl(140, 100%, 10%);
}
.avgs tr:nth-child(3) > td {
  background-color: hsl(100, 100%, 10%);
}
.avgs tr:nth-child(4) > td {
  background-color: hsl(60, 100%, 10%);
}
.avgs tr:nth-child(5) > td {
  background-color: hsl(20, 100%, 10%);
}
.avgs tr:nth-child(6) > td {
  background-color: hsl(20, 100%, 10%);
}
.border {
  border-right: .5rem solid var(--table-border);
}
.border-thin {
  border-right: .25rem solid var(--table-border);
}
</style>
{% endblock add_style %}

{% block the_main %}
<main id="dmg-done" data-source-name="{{ SOURCE_NAME }}" data-report-id="{{ REPORT_ID }}">
<section id="target-select-wrap">
  <button type="button" id="target-select-reset">All</button>
  <select id="target-select">
    <option>Select specific target:</option>
    {% for guid_id, target_name in TARGETS.items() %}
    <option value="{{ guid_id }}">{{ target_name }}</option>
    {% endfor %}
  </select>
</section>
<section id="player-nav-wrap">
  <ul id="player-nav">
    <li><a href="/reports/{{ REPORT_ID }}/player/{{ SOURCE_NAME }}/{{ QUERY }}">DAMAGE</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/heal/{{ SOURCE_NAME }}/{{ QUERY }}">HEAL</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/taken/{{ SOURCE_NAME }}/{{ QUERY }}">TAKEN</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/healed/{{ SOURCE_NAME }}/{{ QUERY }}">HEALED</a></li>
    <li><a href="/reports/{{ REPORT_ID }}/casts/{{ SOURCE_NAME }}/{{ QUERY }}">TIMELINE</a></li>
</section>
<section>
  <ul id="player-info">
    <li class="{{ PLAYER_CLASSES[SOURCE_NAME] }} player-name-big">{{ SOURCE_NAME }}</li>
    <li><a id="warmane-armory-link" href="https://armory.warmane.com/character/{{ SOURCE_NAME }}/{{ SERVER }}" target="_blank">Armoryâ‡—</a></li>
    <li><input type="checkbox" id="toggle-graph"><label for="toggle-graph">Show graph</label></li>
    <li class="sliced-control">
      <span>Sliced</span>
      <select id="sliced-sec">
        <option value=0 selected>0</option>
        <option value=1>1</option>
        <option value=2>2</option>
        <option value=3>3</option>
        <option value=5>5</option>
        <option value=10>10</option>
        <option value=15>15</option>
        <option value=20>20</option>
        <option value=30>30</option>
      </select>
      <span>sec</span>
    </li>
  </ul>
  <div id="chart-wrap">
    <canvas id="chart"></canvas>
  </div>
</section>
<section id="dmg-done-main" class="table-wrap wrap-spell">
  {% if SPELLS_DATA %}
  <div class="table-wrap wrap-spell">
    <table>
      <tbody>
        <tr>
          <th class="spell-name">-</th>
          <th colspan="2">Actual</th>
          <th colspan="2">Reduced</th>
          <th colspan="2"></th>
          <th colspan="6">Direct hits</th>
          <th colspan="6">Periodic hits</th>
        </tr>
        <tr>
          <th class="spell-name">Spell</th>
          <th>%</th>
          <th>Amount</th>
          <th>%</th>
          <th>Amount</th>
          <th>Cast</th>
          <th>Miss</th>
          <th>Total</th>
          <th colspan="2">Hits</th>
          <th colspan="3">Crits</th>
          <th>Total</th>
          <th colspan="2">Hits</th>
          <th colspan="3">Crits</th>
        </tr>
        {% for spell_id, spell_data in SPELLS_DATA.items() %} 
        <tr>
          <td class="spell-name">
            <img src="/static/icons/{{ spell_data['icon'] }}.jpg">
            <a class="{{ spell_data['color'] }}" href="/reports/{{ REPORT_ID }}/spell/{{ spell_data['id'] }}/{{ QUERY }}">{{ spell_data['name'] }}</a>
          </td>
          <td class="count">{{ ACTUAL_PERCENT[spell_id] }}</td>
          <td class="total-cell border">{{ ACTUAL[spell_id] }}</td>
          <td class="count">{{ REDUCED_PERCENT[spell_id] }}</td>
          <td class="total-cell border">{{ REDUCED[spell_id] }}
            {% if REDUCED_DETAILED[spell_id] %}
            <table class="tooltip">
              {% for t, a in REDUCED_DETAILED[spell_id].items() %}
              <tr><td>{{ t }}</td><td>{{ a }}</td></tr>
              {% endfor %}
            </table>
            {% endif %}
          </td>
          <td class="count">{{ CASTS[spell_id] }}</td>
          <td class="count border">{{ MISSES[spell_id] }}
            {% if MISS_DETAILED[spell_id] %}
            <table class="tooltip">
              {% for t, a in MISS_DETAILED[spell_id].items() %}
              <tr>
                <td>{{ t }}</td>
                <td>{{ a }}</td>
              </tr>
              {% endfor %}
            </table>
            {% endif %}
          </td>
          {% for _type, _data in HITS.get(spell_id, {}).items() %} 
          <td class="count border-thin">{{ _data['total'] }}</td>
          <td class="count">{{ _data['hits'] }}</td>
          <td class="count border-thin">{{ _data['hit_avg'] }}
            {% if _data['hits_avg'] %}
            <table class="tooltip avgs"><tbody>
              {% for x in _data['hits_avg'] %}
              <tr><td>{{ x }}</td></tr>
              {% endfor %}
            </tbody></table>
            {% endif %}
          </td>
          <td class="count">{{ _data['crits'] }}</td>
          <td class="count">{{ _data['crit_avg'] }}
            {% if _data['crits_avg'] %}
            <table class="tooltip avgs">
              <tbody>
                {% for x in _data['crits_avg'] %}
                <tr><td>{{ x }}</td></tr>
                {% endfor %}
            </tbody></table>
            {% endif %}
          </td>
          <td class="count border">{{ _data['percent'] }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td class="spell-name">Total</td>
          <td></td>
          <td class="border">{{ ACTUAL["Total"] }}</td>
          <td></td>
          <td class="border">{{ REDUCED["Total"] }}</td>
          <td colspan="69"></td>
        </tr>
      </tfoot>
    </table>
  </div>
  {% else %}
  <p>No data</p>
  {% endif %}
</section>
{% if ABORBS_DETAILS %}
<section>
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Flag</th>
        <th>Source</th>
        <th>Spell name</th>
        <th>Amount</th>
        <th>Total Hit</th>
      </tr>
    </thead>
    <tbody>
      {% for ts, flag, sguid, spellid, amount, hit in ABORBS_DETAILS %}
      <tr>
        <td>{{ts}}</td>
        <td>{{flag}}</td>
        <td class="{{ PLAYER_CLASSES[sguid] }}">{{ sguid }}</td>
        <td class="spell-name">{{spellid}}</td>
        <td>{{amount}}</td>
        <td>{{hit}}</td>

      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}
</main>
{% endblock the_main %}

{% block the_scripts %}
<script>
const TARGET_RESET = document.getElementById("target-select-reset");
const TARGET_SELECT = document.getElementById("target-select");
const CHART_ELEMENT_WRAP = document.getElementById('chart-wrap');
const TOGGLE_GRAPH = document.getElementById('toggle-graph');
const SELECT_SLICE_SECONDS = document.getElementById("sliced-sec");
const GET_DPS_REQUEST = new XMLHttpRequest();
const main = document.querySelector("main");
const REPORT_ID = main.getAttribute("data-report-id");
const SOURCE_NAME = main.getAttribute("data-source-name");
const QUERY_PARAMS = new URLSearchParams(location.search);
const TARGET = QUERY_PARAMS.get('target');
TARGET ? TARGET_SELECT.value = TARGET : TARGET_SELECT.selectedIndex = 0;

function redirect(event) {
  const isReset = (TARGET_SELECT.selectedIndex == 0 || event.target == TARGET_RESET);
  isReset ? QUERY_PARAMS.delete('target') : QUERY_PARAMS.set('target', TARGET_SELECT.value);
  location.replace(`${location.origin}${location.pathname}?${QUERY_PARAMS}`);
};

function togglegraph() {
  if (!TOGGLE_GRAPH.checked) {
    CHART_ELEMENT_WRAP.style.display = "none";
  } else {
    send_post();
    CHART_ELEMENT_WRAP.style.removeProperty("display");
  }
}

function send_post() {
  if (!TOGGLE_GRAPH.checked) return;
  QUERY_PARAMS.set("player_name", SOURCE_NAME)
  QUERY_PARAMS.set("sec", SELECT_SLICE_SECONDS.value);
  const params_obj = Object.fromEntries(QUERY_PARAMS);
  const END_POINT = `/reports/${REPORT_ID}/get_dps`;
  GET_DPS_REQUEST.open("POST", END_POINT);
  GET_DPS_REQUEST.send(JSON.stringify(params_obj));
}


const options = {
  maintainAspectRatio: false,
    animation: false,
    animation: false,
    responsive: true,
  animation: false,
    responsive: true,
  scales: {
    y: {
      grid: {
        color: '#141414',
        tickLength: 1,
      },
      title: {
        display: true,
        text: 'DPS',
      },
      ticks: {
        padding: 0,
      },
    },
    x: {
      grid: {
        color: '#141414',
        tickLength: 1,
      },
    }
  },
  plugins: {
    tooltip: {
      intersect: false,
    },
    legend: {
      display: false,
    },
  },
  interaction: {
    mode: 'index',
  }
};
const CHART = new Chart(document.getElementById('chart'), {
  type: 'line',
  options: options,
});

GET_DPS_REQUEST.onreadystatechange = () => {
  if (GET_DPS_REQUEST.readyState != 4 || GET_DPS_REQUEST.status != 200) return;
  const datapoints = JSON.parse(GET_DPS_REQUEST.response);
  chartSetData(datapoints);
}

function make_new_dataset(datapoints) {
  return {
    data: datapoints,
    cubicInterpolationMode: 'monotone',
    borderColor: '#6900cc',
    pointBorderWidth: 0,
  }
}

function chartSetData(datapoints) {
  if (Object.keys(datapoints).length === 0 && CHART.data.datasets.length === 0) {
    return
  }
  const datapoints_values = Object.values(datapoints);
  const datapoints_min = Math.min(...datapoints_values);
  const datapoints_max = Math.max(...datapoints_values);
  CHART.options.scales.y.min = Math.floor(datapoints_min);
  CHART.options.scales.y.max = Math.ceil(datapoints_max);
  CHART.data.datasets[0] = make_new_dataset(datapoints);
  CHART.update();
}

togglegraph();
TOGGLE_GRAPH.addEventListener("change", togglegraph);
TARGET_RESET.addEventListener("click", redirect);
TARGET_SELECT.addEventListener("change", redirect);
SELECT_SLICE_SECONDS.addEventListener("change", send_post);
</script>
{% endblock the_scripts %}